# Load W9 WRTDS data
load("data_input/eList_W9_Alk_2.RData")
eList_W9_Alk$Sample$ConcAve <- eList_W9_Alk$Sample$ConcAve/10 + runif(n = 1, min = 0, max = 20)
eList_W9_Alk$Daily$ConcDay <- eList_W9_Alk$Daily$ConcDay/10  + runif(n = 1, min = 0, max = 20)
W9_9123_Alk$ANC_all <- W9_9123_Alk$ANC_all/10  + runif(n = 1, min = 0, max = 20)
save.image("D:/Github_Repository/GAM-DiD/GAM_DiD_share/data_input/eList_W9_Alk_2.RData")
#1. Load data
source("script/01_glm_erw_load_data_250806.R")
#2. Run this function to clean the data
source("script/02_glm_erw_data_clean_for_glm_0804.R")
#3. Define  unites
mg2t     <- 1/1e9 # Ca Mg Na
mueql2ct <- 1/1e6*44/1e6 # Alk to CO2 t
ppb2t    <- 1/1e12 # Si
cfs2ls   <- 28.3168
m3s2cfs  <- 35.31467
w2km2    <- 0.0886 # basalt area in the north
#4. Define data frame to store data
max_delta_2024 <- list()
df_flux_3m     <- list()
################################## [Alk]  #######################################
#5. Import data for the GAM-DiD model
#A. Define units
unifact     <- 1#  unit transfer from W9 to W2 Alk
uni_w2_tran <- 1
#B. Generalize eList data
eList_w2 <- eList_W2_Alk
eList_w9 <- eList_W9_Alk
#C. Pick the target element from W2 data for analysis
data_w2_all$c_target  <- data_w2_all$Alk
data_w2_2324$c_target <- data_w2_2324$Alk
#D. Pick the target element from W9 data for analysis
data_w9_2019_24_avg$c_target <- data_w9_2019_24_avg$ANC.µeq.L
data_w9_2019_24_unique$c_target <- data_w9_2019_24_unique$ANC.µeq.L
# 6. GAM-DiD run:  script 03-GAM model to run GAM model
#A. Output file names
filename_csv = "data_output/gam_Alk.csv"  # save GAM results
filename_fig = "figure/gam_Alk.pdf"  # or .pdf/.tiff/.jpeg
filename_preobs <-  "figure/preobs_Alk.pdf"
#B. Run script 03-GAM model to run each element
source("script/03_GAM_model_run.R")
# Assume Basalt application date
basalt_date <- as.Date("2023-07-01")
# Transfer the W9 concentration unit to W2 concentration unit
eList_w9$Daily$ConcDay_ppm <- eList_w9$Daily$ConcDay*unifact;
# Assign W9 daily concentration to W9_eList_conc_daily
W9_eList_conc_daily <- eList_w9$Daily[, c("Date", "ConcDay_ppm")] # Note: ppm not for alk
# Perform a cross join and then filter (join with the W2 2022-2024 data)
NTN_join <- data_w2_all %>%
mutate(key = 1) %>%
left_join(NTN_cleaned %>% mutate(key = 1), by = "key") %>%
filter(Date > dateOn & Date <= dateOff) %>%
select(Date, SO4 = SO4, ph = ph, NO3 = NO3) %>%
distinct()
# Perform a cross join and then filter (join with the W2 1992-2023 data)
NTN_join2 <- eList_w2$Sample %>%
mutate(key = 1) %>%
left_join(NTN_cleaned %>% mutate(key = 1), by = "key") %>%
filter(Date > dateOn & Date <= dateOff) %>%
select(Date, SO4 = SO4, ph = ph, NO3 = NO3) %>%
distinct()
# Perform a cross join and then filter (join with the W2 1992-2024 data)
NTN_9224 <- bind_rows(NTN_join, NTN_join2) %>%
distinct(Date, .keep_all = TRUE) %>%
arrange(Date)
# Perform a cross join and then filter (join with the W9 data)
NTN_join_w9 <- data_w9_2019_24_unique %>%
mutate(key = 1) %>%
left_join(NTN_cleaned %>% mutate(key = 1), by = "key") %>%
filter(Date > dateOn & Date <= dateOff) %>%
select(Date, SO4 = SO4, ph = ph, NO3 = NO3) %>%
distinct()
# Create a column named c_target to make the colume name identical
eList_w2$Sample$c_target <- eList_w2$Sample$ConcAve
# Combine the target concentrations from 1992 to 2024, Keep only Date and c_target from both datasets
combined_simplified <- bind_rows(
eList_w2$Sample %>% select(Date, c_target),
data_w2_all %>% select(Date, c_target)
) %>%
distinct()  # Remove duplicate rows (same Date & c_target)
data_combined <- data_w2_all %>%
left_join(NTN_9224,      by = "Date") %>%
left_join(prism_daily, by = "Date") %>%
left_join(W9_eList_conc_daily, by = "Date") %>%  # Limited data after Aug 2024
left_join(q_daily_W9,  by = "Date")
data_combined <- data_combined %>%
filter(Date %in% data_w2_all$Date[!is.na(data_w2_all$Discharge)])
# With no NTN data due to lack of data
data_combined2 <- data_w2_all %>%
left_join(prism_daily, by = "Date") %>%
left_join(W9_eList_conc_daily, by = "Date") %>%
left_join(q_daily_W9,  by = "Date")
data_combined2 <- data_combined2 %>%
filter(Date %in% data_w2_all$Date[!is.na(data_w2_all$Discharge)])
data_combined$Basalt       <- ifelse(data_combined$Date >= as.Date("2023-07-01"), 1, 0)
data_combined2$Basalt      <- ifelse(data_combined2$Date >= as.Date("2023-07-01"), 1, 0)
# Add a column to identify the group (1 = treatment, 0 = control)
data_combined$Group      <- ifelse(is.na(data_combined$ConcDay), 1, 0)
data_combined2$Group     <- ifelse(is.na(data_combined2$ConcDay), 1, 0)
# Create separate datasets for treatment and control
data_combined$conc_W9       <- data_combined$ConcDay_ppm
data_combined2$conc_W9      <- data_combined2$ConcDay_ppm
treatment_data <- data_combined %>%
select(Date, c_target, Discharge, SO4, ph, NO3, ppt..mm., tmean..degrees.C., Basalt) %>%
mutate(Group = 1)  # Treatment group
control_data <- data_combined %>%
select(Date, c_target = conc_W9, Discharge = Qdaily, SO4, ph, NO3, ppt..mm., tmean..degrees.C., Basalt) %>%
mutate(Group = 0)  # Control group
treatment_data2 <- data_combined2 %>%
select(Date, c_target, Discharge, ppt..mm., tmean..degrees.C., Basalt) %>%
mutate(Group = 1)  # Treatment group
control_data2 <- data_combined2 %>%
select(Date, c_target = conc_W9, Discharge = Qdaily, ppt..mm., tmean..degrees.C., Basalt) %>%
mutate(Group = 0)  # Control group
# Update the climate data of w9
control_data <- control_data %>%
select(-`ppt..mm.`, -`tmean..degrees.C.`) %>%  # drop old values
left_join(
prism_daily_w9 %>% select(Date, `ppt..mm.`, `tmean..degrees.C.`),
by = "Date"
)
control_data2 <- control_data2 %>%
select(-`ppt..mm.`, -`tmean..degrees.C.`) %>%  # drop old values
left_join(
prism_daily_w9 %>% select(Date, `ppt..mm.`, `tmean..degrees.C.`),
by = "Date"
)
# Use the real W-9 measurement for the did model control
control_data_obs <- data_w9_2019_24_unique %>%   #use this for average data for strom days data_w9_2019_24_avg
select(`Date`,`c_target`,`W9_Flow_cfs`) %>%  # drop old values
left_join(
prism_daily_w9 %>% select(Date, `ppt..mm.`, `tmean..degrees.C.`),
by = "Date"
)%>%
left_join(NTN_join_w9,      by = "Date")
control_data_obs$Basalt       <- ifelse(control_data_obs$Date >= as.Date("2023-07-01"), 1, 0)
control_data_obs$Group        <- ifelse(is.na(control_data_obs$c_target), 1, 0)
names(control_data_obs)[names(control_data_obs) == "W9_Flow_cfs"] <- "Discharge"
control_data_obs <- control_data_obs[control_data_obs$Date >= as.Date("2021-05-01"), ]
data_w2_post_obs          <- data_w2_all [data_w2_all$Date >= as.Date("2023-07-01"), ]
data_w2_post_obs$c_target <- data_w2_post_obs$c_target*uni_w2_tran
data_w9_post_wrtds <- control_data[control_data$Date >= as.Date("2023-07-01"), ]
data_w9_post_wrtds <- data_w9_post_wrtds %>%
filter(Date %in% data_w2_post_obs$Date)
data_w2_pre_wrtds  <- eList_w2$Daily[eList_w2$Daily$Date < as.Date("2023-07-01")&eList_w2$Daily$Date >= as.Date("2021-05-01"), ]
data_w2_pre_wrtds$Discharge <- data_w2_pre_wrtds$Q *m3s2cfs
data_w2_pre_wrtds$c_target  <- data_w2_pre_wrtds$ConcDay * uni_w2_tran
data_w2_pre_obs          <- data_w2_all [data_w2_all$Date < as.Date("2023-07-01"), ]
data_w2_pre_obs$c_target <- data_w2_pre_obs$c_target*uni_w2_tran
data_w9_pre_wrtds  <- eList_w9$Daily[eList_w9$Daily$Date < as.Date("2023-07-01")&eList_w9$Daily$Date >= as.Date("2021-05-01"), ]
data_w9_pre_wrtds$Discharge  <- data_w9_pre_wrtds$Q *m3s2cfs
data_w9_pre_wrtds$c_target   <- data_w9_pre_wrtds$ConcDay * unifact
data_w9_pre_obs <- control_data_obs[control_data_obs$Date >= as.Date("2021-05-01")&control_data_obs$Date < as.Date("2023-07-01"), ]
data_w9_pre_obs$c_target <- data_w9_pre_obs$c_target * unifact
data_w2_post_obs          <- data_w2_all [data_w2_all$Date >= as.Date("2023-07-01"), ]
data_w2_post_obs$c_target <- data_w2_post_obs$c_target*uni_w2_tran
data_w9_post_wrtds <- control_data[control_data$Date >= as.Date("2023-07-01"), ]
data_w9_post_wrtds <- data_w9_post_wrtds %>%
filter(Date %in% data_w2_post_obs$Date)
data_w2_pre_wrtds  <- eList_w2$Daily[eList_w2$Daily$Date < as.Date("2023-07-01")&eList_w2$Daily$Date >= as.Date("2021-05-01"), ]
data_w2_pre_wrtds$Discharge <- data_w2_pre_wrtds$Q *m3s2cfs
data_w2_pre_wrtds$c_target  <- data_w2_pre_wrtds$ConcDay * uni_w2_tran
data_w2_pre_obs          <- data_w2_all [data_w2_all$Date < as.Date("2023-07-01"), ]
data_w2_pre_obs$c_target <- data_w2_pre_obs$c_target*uni_w2_tran
data_w9_pre_wrtds  <- eList_w9$Daily[eList_w9$Daily$Date < as.Date("2023-07-01")&eList_w9$Daily$Date >= as.Date("2021-05-01"), ]
data_w9_pre_wrtds$Discharge  <- data_w9_pre_wrtds$Q *m3s2cfs
data_w9_pre_wrtds$c_target   <- data_w9_pre_wrtds$ConcDay * unifact
data_w9_pre_obs <- control_data_obs[control_data_obs$Date >= as.Date("2021-05-01")&control_data_obs$Date < as.Date("2023-07-01"), ]
data_w9_pre_obs$c_target <- data_w9_pre_obs$c_target * unifact
data_w9_pre_wrtds$logc <- log(data_w9_pre_wrtds$c_target)
data_w9_pre_wrtds$logc <- log(data_w9_pre_wrtds$c_target)
data_w9_pre_wrtds$logq <- log(data_w9_pre_wrtds$Discharge)
data_w9_post_wrtds$logc <- log(data_w9_post_wrtds$c_target)
data_w9_post_wrtds$logq <- log(data_w9_post_wrtds$Discharge)
data_w2_pre_wrtds$logc <- log(data_w2_pre_wrtds$c_target)
data_w2_pre_wrtds$logq <- log(data_w2_pre_wrtds$Discharge)
data_w2_post_obs$logc <- log(data_w2_post_obs$c_target)
data_w9_pre_obs$c_target <- data_w9_pre_obs$c_target * unifact
View(data_w9_pre_obs)
View(data_w9_pre_obs)
#1. Load data
source("script/01_glm_erw_load_data_250806.R")
#2. Run this function to clean the data
source("script/02_glm_erw_data_clean_for_glm_0804.R")
#3. Define  unites
mg2t     <- 1/1e9 # Ca Mg Na
mueql2ct <- 1/1e6*44/1e6 # Alk to CO2 t
ppb2t    <- 1/1e12 # Si
cfs2ls   <- 28.3168
m3s2cfs  <- 35.31467
w2km2    <- 0.0886 # basalt area in the north
#4. Define data frame to store data
max_delta_2024 <- list()
df_flux_3m     <- list()
################################## [Alk]  #######################################
#5. Import data for the GAM-DiD model
#A. Define units
unifact     <- 1#  unit transfer from W9 to W2 Alk
uni_w2_tran <- 1
#B. Generalize eList data
eList_w2 <- eList_W2_Alk
eList_w9 <- eList_W9_Alk
#C. Pick the target element from W2 data for analysis
data_w2_all$c_target  <- data_w2_all$Alk
data_w2_2324$c_target <- data_w2_2324$Alk
#D. Pick the target element from W9 data for analysis
data_w9_2019_24_avg$c_target <- data_w9_2019_24_avg$ANC.µeq.L
data_w9_2019_24_unique$c_target <- data_w9_2019_24_unique$ANC.µeq.L
# 6. GAM-DiD run:  script 03-GAM model to run GAM model
#A. Output file names
filename_csv = "data_output/gam_Alk.csv"  # save GAM results
filename_fig = "figure/gam_Alk.pdf"  # or .pdf/.tiff/.jpeg
filename_preobs <-  "figure/preobs_Alk.pdf"
#B. Run script 03-GAM model to run each element
source("script/03_GAM_model_run.R")
#1. Load data
source("script/01_glm_erw_load_data_250806.R")
#2. Run this function to clean the data
source("script/02_glm_erw_data_clean_for_glm_0804.R")
#3. Define  unites
mg2t     <- 1/1e9 # Ca Mg Na
mueql2ct <- 1/1e6*44/1e6 # Alk to CO2 t
ppb2t    <- 1/1e12 # Si
cfs2ls   <- 28.3168
m3s2cfs  <- 35.31467
w2km2    <- 0.0886 # basalt area in the north
#4. Define data frame to store data
max_delta_2024 <- list()
df_flux_3m     <- list()
################################## [Alk]  #######################################
#5. Import data for the GAM-DiD model
#A. Define units
unifact     <- 1#  unit transfer from W9 to W2 Alk
uni_w2_tran <- 1
#B. Generalize eList data
eList_w2 <- eList_W2_Alk
eList_w9 <- eList_W9_Alk
#C. Pick the target element from W2 data for analysis
data_w2_all$c_target  <- data_w2_all$Alk
data_w2_2324$c_target <- data_w2_2324$Alk
#D. Pick the target element from W9 data for analysis
data_w9_2019_24_avg$c_target <- data_w9_2019_24_avg$ANC.µeq.L
data_w9_2019_24_unique$c_target <- data_w9_2019_24_unique$ANC.µeq.L
# 6. GAM-DiD run:  script 03-GAM model to run GAM model
#A. Output file names
filename_csv = "data_output/gam_Alk.csv"  # save GAM results
filename_fig = "figure/gam_Alk.pdf"  # or .pdf/.tiff/.jpeg
filename_preobs <-  "figure/preobs_Alk.pdf"
#B. Run script 03-GAM model to run each element
source("script/03_GAM_model_run.R")
#C. Results from the GAM model
new_data_daily_did_Alk      <- new_data_daily_did # prediction with basalt application
new_data_daily_did_fake_Alk <- new_data_daily_did_fake  # prediction without basalt application
# unit identification
unifact_Alk <- unifact
#D. Get summary
sum_Alk <- sum_gam
#E. Post run data analysis
source("script/04_post_GAM_analysis.R")
# unit identification
uni_fig <- 1
#7. Plot treatment-effect delta C %
ylab_fig = expression(Delta *c ~ Alkalinity~"["~"%"~"]")
filename_fig = "figure/deltac_per_Alk_treatment_effect.pdf"  # or .pdf/.tiff/.jpeg
source("script/07_figure4_deltaC_percent.R")
